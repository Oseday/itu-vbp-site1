<html lang="en">
	<link type="text/css" rel="stylesheet" id="dark-mode-general-link">
	<link type="text/css" rel="stylesheet" id="dark-mode-custom-link">

	<style type="text/css" id="dark-mode-custom-style"></style>
	<head>
		<link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
		<link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
		<link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
		<link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
		<link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
		<link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
		<link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
		<link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
		<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
		<link rel="manifest" href="https://verbipati.org/manifest.webmanifest">
		<meta name="msapplication-TileColor" content="#ffffff">
		<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
		<meta name="theme-color" content="#ffffff">

		<meta http-equiv='cache-control' content='no-cache'>
		<meta http-equiv='expires' content='0'>
		<meta http-equiv='pragma' content='no-cache'>

		<meta name="application-name" content="VerBiPati">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name="description" content="VerBiPati web app for dogs and cats">

		<!-- Bootstrap core CSS -->
		<link href="https://verbipati.org/bootstrap-4.5.2-dist/css/bootstrap.min.css" rel="stylesheet">

		<meta name="theme-color" content="#563d7c">

		<style type="text/css">
			* { box-sizing: border-box; }

			.grid:after {
			  content: '';
			  display: block;
			  clear: both;
			}

			.grid-sizer,
			.grid-item {
			  width: 225px;
			}
			@media (max-width: 360px) {
			  .grid-sizer,
			  .grid-item {
				width: 50%;
			  }
			}
			@media (min-width: 361px) and (max-width: 760px) {
			  .grid-sizer,
			  .grid-item {
				width: 33.333%;
			  }
			}

			.grid-item {
			  float: left;
			}

			.grid-item img {
			  display: block;
			  max-width: 100%;
			}

			.animal-container {
				background-color: #c0c0c0;
				padding-top: 4px;
				padding-bottom: 16px;
				margin-bottom: 12px;
			}

			.no-padding{
				padding: 0px;
				padding-top: 0px;
				padding-bottom: 0px;
				padding-left: 0px;
				padding-right: 0px;
			}

			.progress-extra{
				margin-left: 28px;
				margin-right: 28px;
				margin-top: 16px;
			}

			.progress-bar-extra{
				transition: width .08s ease;
			}

			.newanibtn{
				margin-left: 28px;
				margin-right: 28px;
				margin-bottom: 16px;
				margin-top: 16px;
			}

			.modal-dialog-full {
			  width: 100%;
			  height: 100%;
			  margin: 0px;
			  margin-right: 0px;
			  padding: 0.25%;
			  max-width: 99999px;
			}

			.modal-content-full {
			  height: auto;
			  width: 100%;
			  min-height: 100%;
			}

			.modal-body-full {
			  padding: 2px;
			}

			.modal-c-image {
				width: 100%;
			}

			.image-ose{}
		</style>

	</head>


	<body class="text-center" style="overflow-y: scroll">
			<title>VerBiPati Fotoğraf Kataloğu</title>
			<h1 class="text-center" id="greet">Fotoğraf Kataloğu</h1>
			<h2 class="text-center text-capitalize" id="locname"></h2>

			<div class="modal fade" id="UploadModal" tabindex="-1" role="dialog" aria-labelledby="AniAddModalLabel" aria-hidden="true">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h6 class="modal-title" id="AniAddModalLabel">Fotoğraf Ekle</h6>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<div class="modal-body">
							<input type="name" style="margin-bottom: 8px;" class="form-control" id="animalnameinput" placeholder="Hayvan adı" name="animalname-2"></input>
							<div class="input-group">
							  <div class="input-group-prepend">
								<button class="input-group-text" id="fileupload">Yükle</button>
							  </div>
							  <div class="custom-file">
								<input type="file" class="custom-file-input" id="fileinput" accept="image/*;capture=camera" aria-describedby="fileupload" data-show-caption="true" multiple></input>
								<label class="custom-file-label text-left" for="fileinput">Fotoğraf seçin</label>
							  </div>
							</div>

							<div class="progress progress-extra" id="progressparent"><div class="progress-bar progress-bar-striped progress-bar-animated progress-bar-extra bg-success" role="progressbar" id="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div></div>
						</div>
					</div>
				</div>
			</div>


			<div class="modal fade" id="PhotoModal" tabindex="-2" role="dialog" aria-labelledby="PhotoModalLabel" aria-hidden="true">
				<div class="modal-dialog modal-dialog-full" role="document">
					<div class="modal-content modal-content-full">
						<div class="modal-header">
							<h5 class="modal-title" id="PhotoModalLabel">Fotoğraf</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<div class="modal-body modal-body-full">
							<img class="modal-c-image" id="PhotoModalsrc" src="https://via.placeholder.com/150"></div>
							<div class="btn-group" role="group" aria-label="Basic example">
								<button type="button" id="PhotoModaldel" data-animalname="" class="btn btn-danger btn-sm">Sil</button>
								<button type="button" id="PhotoModaldownload" data-animalname="" class="btn btn-secondary btn-sm">İndir</button>
							</div>
						</div>
					</div>
				</div>
			</div>


			<div class="col-12 no-padding" id="lists">
				
			</div>


			<div class="newanibtn">
				<a class="btn btn-outline-dark btn-lg btn-block" data-toggle="modal" id="openmodal" data-target="#UploadModal" data-animalname="">Yeni Hayvan Ekle</a>
			</div>

	</body>


	<script src="https://verbipati.org/jquery.js" type="text/javascript"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/javascript.util/0.12.12/javascript.util.min.js" type="text/javascript"></script>
	<script src="https://verbipati.org/bootstrap-4.5.2-dist/js/bootstrap.min.js" type="text/javascript"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/1.0.0/mdb.min.js"></script>

	<script src="https://verbipati.org/jscookies.js" type="text/javascript"></script>
	<script src="https://verbipati.org/getbrowser.js" type="text/javascript"></script>

	<script src="https://verbipati.org/modules/download.js" type="text/javascript"></script>
	<script src="https://verbipati.org/modules/detectmobilebrowser.js" type="text/javascript"></script>

	<script src="https://verbipati.org/mdb-4.19.1/js/addons/masonry.pkgd.min.js" type="text/javascript"></script>
	<script src="https://verbipati.org/mdb-4.19.1/js/addons/imagesloaded.pkgd.min.js" type="text/javascript"></script>

	<script src="https://unpkg.com/axios/dist/axios.min.js" type="text/javascript"></script>
	<script type="text/javascript">
		async function total(){
			let hrefsplit = window.location.href.split("/")
			let locname = hrefsplit[hrefsplit.length-1]
			//locname = "HMvHFdBKV1Xmoup40Kjd"
			console.log(locname)

            let username = getCookie("username");
            console.log(username)
            var validusername = false
            if (username) {
            	await $.post("/login", {username: username}).done( function(data) {
                    validusername = true
                }).fail(function(){
                    
                })
            }

            if (!validusername){
            	$('#fileupload').hide();
            	$('#PhotoModaldel').hide();
            	$('.newanibtn').hide();
            }


			$("#progressparent").slideUp(120);
			var UPLOADING = false;
			
			async function SavePhoto(inp) {
				if (UPLOADING==true){return;}
				UPLOADING=true

				console.log(inp)
				console.log(inp.files)
				let aniname = $('#animalnameinput').val();
				for (var i = inp.files.length - 1; i >= 0; i--) {
					try {
						let formData = new FormData();
						formData.append("photo", inp.files[i]);

						$("#progressparent").slideDown(120);

						await axios.request({
							method: "POST",
							url:`https://verbipati.org/photos/${locname}/${aniname}`,
							data: formData,
							onUploadProgress: (p) => {
								console.log(p.loaded / p.total); 
								//$("#progressbar")[0].width = (p.loaded / p.total) + "%"
								$("#progressbar").attr("style",`width: ${100 * p.loaded / p.total}%`);
							}
						}).then(data => {
							$("#progressparent").slideUp(120);
							$("#progressbar").attr("style",`width: 0%`);
						})
					} catch(e) {
						console.log('error:', e);
					}
				}
				
				GetForm();

				UPLOADING = false;
			}


			$('#fileupload').click(function(argument) {
				let aniname = $('#animalnameinput').val();
				if (aniname.length<3){
					$("#animalnameinput").toggleClass("is-invalid", true);
					return;
				}
				SavePhoto($('#fileinput')[0]);
			})

			//if (window.mobileAndTabletCheck){

				//$('.close').hide();

				$('#PhotoModal').on('show.bs.modal', function () {
					//window.location.hash = "#pmodal"
				})
				$('#UploadModal').on('show.bs.modal', function () {
					//window.location.hash = "#umodal"
				})
				var hash = window.location.hash;
				setInterval(function(){
				    if (window.location.hash != hash) {
				        let newhash = window.location.hash;

				        if (hash=="#umodal"){
				        	//$('.modal').modal("hide")
				        	$('#UploadModal').modal("hide")
				        	$('#PhotoModal').modal("hide")
				        	//$('#UploadModal').filter('.modal').modal("hide")
				        }else if(hash=="#pmodal"){
				        	//$('.modal').modal("hide")
				        	$('#UploadModal').modal("hide")
				        	$('#PhotoModal').modal("hide")
				        }
				        hash = newhash;
				    }
				}, 100);
			//}
/*$(".modal").on("shown.bs.modal", function () {
    if ($(".modal-backdrop").length > 1) {
        $(".modal-backdrop").not(':first').remove();
    }
})*/
$(".modal").on('hidden.bs.modal', function () {
  $('.modal-backdrop').remove();
});



			$('#PhotoModaldownload').click(function(argument) {
				//document.location.href = $("#PhotoModalsrc").attr("src");
				//console.log(document.getElementById('PhotoModaldownloadlink').href)
				//document.getElementById('PhotoModaldownloadlink').click()
				download( $("#PhotoModalsrc").attr("src"), `${$('#PhotoModaldownload').attr("name")}`, "image/jpeg" );
			})

			$('#PhotoModaldel').click(async function(){
				if (!validusername){return}
				try{await fetch($("#PhotoModalsrc").attr("src"), {method: "DELETE"})}catch(e){console.log('error:', e);}
				GetForm();
				$('#PhotoModal').modal("hide");
			})

			function GetLocText(rowData,coords) {
				let locationName = rowData[0]
				let details = rowData[5]

				return `<d>${locationName}<i><small>  ${details} </small></i></d>`
			}
//cd deps/ose && git pull origin master && cd ../.. && sudo ./luvit server.lua

			function UpdateForm(data,coords){
				$("#lists").empty();
				for(let [animalname, rowData] of Object.entries(data)){
					let trs = `
							<div class="animal-container">
								<h5 class="text-center text-capitalize">${decodeURI(animalname)} <a ${validusername ? "" : "hidden"} class="btn btn-outline-dark btn-sm no-padding" style="height: 24px; width: 24px;" data-toggle="modal" id="openmodal" data-target="#UploadModal" data-animalname="${animalname}">+</a> </h5> 
								<div class="container-fluid no-padding">
									<div class="grid">
										<div class="grid-sizer"></div>`;

					for(let [_, animalphoto] of Object.entries(rowData)){		
						trs = trs + `<div class="grid-item"> <img class="image-ose" src="https://verbipati.org/minphotos/${locname}/${animalname}/${animalphoto}" mainsrc="https://verbipati.org/photos/${locname}/${animalname}/${animalphoto}" name="${animalphoto}" alt="image" title="${animalname}"></img> </div>`;
					}

					trs = trs + `</div> </div> </div>`;

					$("#lists").append(trs);
				}

				$('.image-ose').click(function(argument) {
					//$('#PhotoModalsrc').src = $(this).src;
					console.log($(this).attr("src"))
					$('#PhotoModalsrc').attr("src",$(this).attr("mainsrc"));

					console.log($(this).attr("data-animalname"))
					$('#PhotoModaldel').attr("data-animalname",$(this).attr("data-animalname"));
					$('#PhotoModaldownload').attr("name",$(this).attr("name"));
					$('#PhotoModal').modal("show");
				})

				$('#UploadModal').on('show.bs.modal', function (event) {
					var button = $(event.relatedTarget) 
					var animalname = button.data('animalname') 
					var modal = $(this)
					console.log(animalname)
					$('#animalnameinput').val(decodeURI(animalname))
				})
				
				$(".list-group-item").click(function(){
					console.log(this.id);
					href = `/photos/${this.id}`;
				})

				var $grid = $('.grid').masonry({
				  itemSelector: '.grid-item',
				  percentPosition: true,
				  columnWidth: '.grid-sizer'
				});

				// layout Masonry after each image loads
				$grid.imagesLoaded().progress( function() {
					var $grid = $('.grid').masonry({
					  itemSelector: '.grid-item',
					  percentPosition: true,
					  columnWidth: '.grid-sizer'
					});
				  $grid.masonry();
				});
			}

			function GetForm() {
				$.post(`https://verbipati.org/photosmeta/${locname}`).done(function(data) {
					UpdateForm(data)
				}).fail(function(){
					//document.location.href = "/viewer";
				})
			}

			GetForm();

			$.get(`https://verbipati.org/locnamefromid/${locname}`).done(function(data) {
				console.log(data)
				$("#locname").text(data)
			})
		};


		$(document).ready(total);
	</script>


</html>